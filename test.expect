#!/usr/bin/expect -f

set timeout 3
set bin "./bin/3_3_calc"

if { ! [file executable $bin] } {
    puts "ERROR: $bin not found or not executable"
    exit 1
}

# Tests: name|operator|numbers|expected_float
set tests {
    "Addition|+|10 20|30.0"
    "Subtraction|-|50 20|30.0"
    "Multiplication|*|6 7|42.0"
    "Division|/|7 2|3.5"
    "Multiple|+|1 2 3 4|10.0"
    "ChainedDiv|/|100 2 5|10.0"
    
    "veResult|-|5 10|-5.0"
    "veChainResult|-|5 10 10|-15.0"
    
    "veValueAddition|+|-10 -20|-30.0"
    "veValueSubtraction|-|-50 -20|-30.0"
    "veValueMultiplication|*|-6 -7|42.0"
    "veValueDivision|/|-7 2|-3.5"
    "DoubleNegDiv|/|-20 -2|10.0"

}

set passed 0
set total 0

foreach t $tests {
    incr total
    set parts [split $t "|"]
    set name [lindex $parts 0]
    set op   [lindex $parts 1]
    set nums [lindex $parts 2]
    set expect_val [lindex $parts 3]

    spawn $bin

    # header + first prompt
    expect {
        -re {enter operation.*:\s*} {}
        -re {ARM BASED CALCULATOR.*enter operation.*:\s*} {}
        timeout { puts "\[$name\] TIMEOUT waiting for prompt"; catch {send "\x1D"}; exit 1 }
    }

    send -- "$op\r"

    expect {
        -re {enter no.*:\s*} {}
        timeout { puts "[$name] TIMEOUT waiting for numbers prompt"; exit 1 }
    }

    send -- "$nums\r"

    expect {
        -re {Result:\s*([-]*[0-9]+)\.([0-9]+)} {
            set intpart $expect_out(1,string)
            set fracpart $expect_out(2,string)
            
            set val [expr {double("$intpart.$fracpart")}]
        }
        -re {Result:\s*([0-9]+)} {
            # no fractional printed
            set intpart $expect_out(1,string)
            set val [expr {double($intpart)}]
        }
        timeout { puts "[$name] TIMEOUT waiting for Result"; exit 1 }
    }

    # compare with tolerance
    set diff [expr {abs($val - double($expect_val))}]
    if { $diff < 0.001 } {
        puts "\[PASS\] $name -> actual=$val expected=$expect_val"
        incr passed
    } else {
        puts "\[FAIL\] $name -> actual=$val expected=$expect_val (diff=$diff)"
    }

    # send '[' to exit this run cleanly
    expect {
        -re {\n} {}
        timeout {}
    }
    send -- "\[\r"
    expect eof
}

puts "Summary: $passed / $total passed"
if { $passed != $total } { exit 2 } else { exit 0 }
